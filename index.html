<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Project Easter Eggs</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&family=Baskervville:wght@400&family=Inter:wght@400&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <div class="main-container">
    <header class="hero">
      <h1 class="hero-title">Yolk of Truth</h1>
      <p class="hero-sub">
        <span>Tap an egg</span>
        <span class="star" aria-hidden="true">
          <img src="./assets/star-05.png" alt="Star" width="16" height="17" />
        </span>
        <span>Watch it break</span>
        <span class="star" aria-hidden="true">
          <img src="./assets/star-05.png" alt="Star" width="16" height="17" />
        </span>
        <span>Discover your fortune</span>
      </p>
      <p class="hero-sub-mobile">Discover your fortune</p>
    </header>
    <main class="board" aria-label="Egg selection grid">
      <section class="egg-grid" role="list" id="eggGrid">
        <div class="egg-tile" role="listitem"><img class="egg-icon" src="./assets/eggs/eggs-01.png" alt="Egg 1" /></div>
        <div class="egg-tile" role="listitem"><img class="egg-icon" src="./assets/eggs/eggs-02.png" alt="Egg 2" /></div>
        <div class="egg-tile" role="listitem"><img class="egg-icon" src="./assets/eggs/eggs-03.png" alt="Egg 3" /></div>
        <div class="egg-tile" role="listitem"><img class="egg-icon" src="./assets/eggs/eggs-04.png" alt="Egg 4" /></div>
        <div class="egg-tile" role="listitem"><img class="egg-icon" src="./assets/eggs/eggs-05.png" alt="Egg 5" /></div>
        <div class="egg-tile" role="listitem"><img class="egg-icon" src="./assets/eggs/eggs-06.png" alt="Egg 6" /></div>
        <div class="egg-tile" role="listitem"><img class="egg-icon" src="./assets/eggs/eggs-07.png" alt="Egg 7" /></div>
        <div class="egg-tile" role="listitem"><img class="egg-icon" src="./assets/eggs/eggs-09.png" alt="Egg 9" /></div>
        <div class="egg-tile" role="listitem"><img class="egg-icon" src="./assets/eggs/eggs-10.png" alt="Egg 10" /></div>
        <div class="egg-tile" role="listitem"><img class="egg-icon" src="./assets/eggs/eggs-01.png" alt="Egg 1" /></div>
      </section>
    </main>
    <div class="cta">
      <button id="musicToggle" class="music-btn" aria-pressed="false">
        <span class="icon on" aria-hidden="true">
          <svg width="20" height="21" viewBox="0 0 20 21" fill="none" xmlns="http://www.w3.org/2000/svg">
            <g opacity="0.45">
              <path d="M14.4406 6.92621C15.0558 7.87107 15.4165 9.02017 15.4165 10.2595C15.4165 11.4989 15.0558 12.648 14.4406 13.5929M9.6878 4.73095L7.2256 7.36902C7.09108 7.51314 7.02382 7.58521 6.94533 7.63674C6.87574 7.68243 6.79987 7.7161 6.72051 7.73652C6.631 7.75954 6.53588 7.75954 6.34564 7.75954H4.99444C4.55885 7.75954 4.34105 7.75954 4.17467 7.85037C4.02833 7.93026 3.90934 8.05775 3.83477 8.21455C3.75 8.39281 3.75 8.62616 3.75 9.09288V11.4262C3.75 11.8929 3.75 12.1263 3.83477 12.3045C3.90934 12.4613 4.02833 12.5888 4.17467 12.6687C4.34105 12.7595 4.55885 12.7595 4.99444 12.7595H6.34564C6.53588 12.7595 6.631 12.7595 6.72051 12.7826C6.79987 12.803 6.87574 12.8367 6.94533 12.8823C7.02382 12.9339 7.09108 13.0059 7.2256 13.1501L9.68779 15.7881C10.021 16.1451 10.1876 16.3236 10.3306 16.3357C10.4547 16.3461 10.576 16.2923 10.6568 16.1909C10.75 16.074 10.75 15.8216 10.75 15.3167V5.20235C10.75 4.6975 10.75 4.44508 10.6568 4.32819C10.576 4.22677 10.4547 4.17295 10.3306 4.18342C10.1876 4.19548 10.021 4.37397 9.6878 4.73095Z" stroke="black" stroke-width="1.66667" stroke-linecap="round" stroke-linejoin="round"/>
            </g>
          </svg>
        </span>
        <span class="icon mute" aria-hidden="true">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <g opacity="0.45">
              <path d="M18.3333 7.50002L13.3333 12.5M13.3333 7.50002L18.3333 12.5M8.02859 4.47142L5.39051 7.1095C5.24639 7.25362 5.17432 7.32569 5.09023 7.37722C5.01567 7.42291 4.93438 7.45658 4.84935 7.477C4.75344 7.50002 4.65153 7.50002 4.44771 7.50002H2.99999C2.53328 7.50002 2.29992 7.50002 2.12166 7.59085C1.96486 7.67074 1.83738 7.79823 1.75748 7.95503C1.66666 8.13329 1.66666 8.36664 1.66666 8.83335V11.1667C1.66666 11.6334 1.66666 11.8668 1.75748 12.045C1.83738 12.2018 1.96486 12.3293 2.12166 12.4092C2.29992 12.5 2.53328 12.5 2.99999 12.5H4.44771C4.65153 12.5 4.75344 12.5 4.84935 12.523C4.93438 12.5435 5.01567 12.5771 5.09023 12.6228C5.17432 12.6744 5.24639 12.7464 5.39051 12.8905L8.02859 15.5286C8.38557 15.8856 8.56406 16.0641 8.7173 16.0761C8.85026 16.0866 8.9802 16.0328 9.06683 15.9314C9.16666 15.8145 9.16666 15.5621 9.16666 15.0572V4.94283C9.16666 4.43798 9.16666 4.18556 9.06683 4.06867C8.9802 3.96725 8.85026 3.91343 8.7173 3.92389C8.56406 3.93595 8.38557 4.11444 8.02859 4.47142Z" stroke="black" stroke-width="1.66667" stroke-linecap="round" stroke-linejoin="round"/>
            </g>
          </svg>
        </span>
      </button>
    </div>
  </div>

  <script>
  (()=>{
    // Music toggle
    const btn = document.getElementById('musicToggle');
    if(!btn) return;
    let audioCtx = null; let osc = null; let gain = null; let playing = false;
    function start() {
      audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
      gain = audioCtx.createGain(); gain.gain.value = 0.05;
      osc = audioCtx.createOscillator(); osc.type = 'sine'; osc.frequency.value = 220;
      osc.connect(gain).connect(audioCtx.destination); osc.start(); playing = true;
    }
    function stop() {
      try { if (osc) { osc.stop(); osc.disconnect(); } } catch(e){}
      osc = null; playing = false;
      if (audioCtx) { /* keep ctx for reuse */ }
    }
    function updateUI() {
      btn.setAttribute('aria-pressed', String(playing));
    }
    btn.addEventListener('click', () => {
      if (!playing) start(); else stop(); updateUI();
    });
    updateUI();
  })();
  </script>

  <script>
  // On egg click, bounce then show fortune (no crack effect)
  (function(){
    const grid = document.getElementById('eggGrid');
    if(!grid) return;
    const fortunes = [
      'A fresh start will put you on your way.',
      'Adventure can be real happiness.',
      'Fortune favors the bold.',
      'Now is the time to try something new.',
      'You will conquer obstacles to achieve success.'
    ];
    grid.addEventListener('click', (e) => {
      const tile = e.target.closest('.egg-tile');
      if (!tile) return;
      const img = tile.querySelector('.egg-icon');
      if (img) {
        // force hover-like scaled state so egg looks active
        img.style.setProperty('--hover-transform', 'scale(1.28) rotate(-10deg) rotateY(18deg)');
        // Add subtle movement animation during the effect
        img.classList.add('animating');
        img.style.animation = 'egg-click-movement 800ms ease-out';
        setTimeout(() => { 
          img.classList.remove('animating'); 
          img.style.animation = 'none'; 
        }, 850);
      }

      // Create animation centered on the egg tile
      const rect = tile.getBoundingClientRect();
      const centerLeft = rect.left + rect.width / 2;
      const centerTop = rect.top + rect.height / 2;

      // Disable scroll during VFX sequence
      document.body.classList.add('no-scroll');

      // Add shake animation to the egg (more pronounced)
      img.style.animation = 'egg-shake-xy 800ms ease-out';
      setTimeout(() => {
        img.style.animation = 'none';
      }, 850);

      // Start directly with expanding circle rings + star particles
      // More Rings (increased from 3 to 5)
      for (let i = 0; i < 5; i++) {
        const circle = document.createElement('div');
        circle.className = 'circle';
        const ringSize = 80 + i * 25;
        circle.style.left = `${centerLeft - ringSize / 2}px`;
        circle.style.top = `${centerTop - ringSize / 2}px`;
        circle.style.width = circle.style.height = `${ringSize}px`;
        circle.style.animationDuration = `${0.8 + i * 0.15}s`;
        document.body.appendChild(circle);
        circle.addEventListener('animationend', () => circle.remove(), { once: true });
      }
      
      // More Stars (increased from 15 to 25)
      for (let i = 0; i < 25; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.left = `${centerLeft}px`;
        star.style.top = `${centerTop}px`;
        const angle = Math.random() * 2 * Math.PI;
        const distance = 80 + Math.random() * 80;
        const dx = Math.cos(angle) * distance + 'px';
        const dy = Math.sin(angle) * distance + 'px';
        star.style.setProperty('--dx', dx);
        star.style.setProperty('--dy', dy);
        document.body.appendChild(star);
        star.addEventListener('animationend', () => star.remove(), { once: true });
      }

      // Wait for the longest ring animation (~1.4s from now) before enabling scroll and showing overlay
      setTimeout(() => {
        document.body.classList.remove('no-scroll');
        
        // Create white radial overlay
        const radialOverlay = document.createElement('div');
        radialOverlay.className = 'radial-overlay';
        radialOverlay.style.left = `${centerLeft - 300}px`;
        radialOverlay.style.top = `${centerTop - 300}px`;
        document.body.appendChild(radialOverlay);
        
        // Show fortune overlay after radial animation starts
        setTimeout(() => {
          // Stop all animations when message appears
          document.querySelectorAll('.circle, .star').forEach(el => {
            el.style.animation = 'none';
            el.remove();
          });
          
          // Stop egg shake animation
          img.style.animation = 'none';
          
          const overlay = document.getElementById('fortuneOverlay');
          const fortuneText = document.getElementById('fortuneText');
          if (!overlay || !fortuneText) return;
          
          const msg = fortunes[Math.floor(Math.random() * fortunes.length)];
          fortuneText.textContent = msg;
          
          // Show overlay properly
          overlay.classList.remove('hidden', 'closing');
          overlay.classList.add('showing');
          
          console.log('Overlay should be visible now', overlay);
        }, 200);
        
        // Remove radial overlay after animation
        setTimeout(() => {
          radialOverlay.remove();
        }, 2000);
      }, 1400);
    });
  })();
  </script>

  <!-- Fortune overlay -->
  <div id="fortuneOverlay" class="overlay hidden" role="dialog" aria-modal="true" aria-labelledby="fortuneText">
    <div class="modal">
      <div class="fortune-card">
        <div class="fortune-image">
          <div class="fortune-gradient"></div>
          <div class="fortune-sparkles">
            <div class="sparkle sparkle-1"></div>
            <div class="sparkle sparkle-2"></div>
            <div class="sparkle sparkle-3"></div>
            <div class="sparkle sparkle-4"></div>
            <div class="sparkle sparkle-5"></div>
          </div>
          <!-- Dummy image for testing -->
          <img src="./assets/eggs/eggs-01.png" alt="Fortune Egg" class="dummy-egg-image" />
        </div>
        <div class="fortune-message">
          <p id="fortuneText">Your fortune awaits! This is a test message to see if the card is visible.</p>
        </div>
      </div>
      <div class="card-actions">
        <button id="shareFortune" class="action-btn">Share</button>
        <button id="tryAgain" class="action-btn">Try Again</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const overlay = document.getElementById('fortuneOverlay');
      const shareBtn = document.getElementById('shareFortune');
      const tryAgainBtn = document.getElementById('tryAgain');
      
      function resetAllEggs() {
        document.querySelectorAll('.egg-icon').forEach((el) => {
          // Clear animations
          el.style.animation = 'none';
          // Reset click-related CSS variables
          el.style.setProperty('--click-tilt-x', '0px');
          el.style.setProperty('--click-tilt-y', '0px');
          el.style.setProperty('--click-tilt-rot', '0deg');
          el.style.setProperty('--shake-x', '0px');
          el.style.setProperty('--shake-y', '0px');
          // Remove any inline hover-transform so stylesheet controls hover again
          el.style.removeProperty('--hover-transform');
          el.classList.remove('animating');
        });
      }
      
      function hide(){
        console.log('Hide function called');
        if (!overlay) {
          console.log('No overlay found');
          return;
        }
        
        // Clear any inline styles that might prevent hiding
        overlay.style.display = '';
        overlay.style.opacity = '';
        overlay.style.pointerEvents = '';
        
        const modal = overlay.querySelector('.modal');
        // Reset modal transform for next time
        if (modal) {
          modal.style.transform = '';
          modal.style.transition = '';
          modal.style.opacity = '';
        }
        
        overlay.classList.remove('showing');
        overlay.classList.add('closing');
        setTimeout(()=>{ 
          overlay.classList.add('hidden'); 
          overlay.classList.remove('closing');
          // After closing, reset all eggs to default state
          resetAllEggs();
          console.log('Modal closed');
        }, 320);
      }
      
      // Add keyboard escape handler
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && overlay && !overlay.classList.contains('hidden')) {
          console.log('Escape key pressed');
          hide();
        }
      });
      
      function shareFortune() {
        const fortuneText = document.getElementById('fortuneText');
        const text = fortuneText?.textContent || '';
        
        if (navigator.share) {
          navigator.share({
            title: 'My Fortune',
            text: text,
            url: window.location.href
          });
        } else {
          // Fallback: copy to clipboard
          navigator.clipboard.writeText(text).then(() => {
            alert('Fortune copied to clipboard!');
          });
        }
      }
      
      function tryAgain() {
        console.log('Try Again clicked');
        hide();
      }
      
      function closeModal() {
        console.log('Closing modal');
        hide();
      }
      
      shareBtn?.addEventListener('click', shareFortune);
      tryAgainBtn?.addEventListener('click', tryAgain);
      
      // Close modal when clicking anywhere on the overlay
      overlay?.addEventListener('click', (e)=>{ 
        console.log('Overlay clicked', e.target);
        closeModal();
      });
      
      // Prevent card clicks from closing the modal
      const fortuneCard = overlay?.querySelector('.fortune-card');
      fortuneCard?.addEventListener('click', (e) => {
        console.log('Card clicked - preventing close');
        e.stopPropagation();
      });
    })();
  </script>

  <script>
  // Mobile swipe carousel: infinite loop with shuffle, one-step swipe, haptics, and rotate effect
  (function(){
    const grid = document.getElementById('eggGrid');
    if (!grid) return;

    const isMobile = () => window.matchMedia('(max-width: 640px)').matches;
    let initialized = false;

    function shuffleNoAdjDup(nodes){
      const arr = nodes.slice();
      // Fisher-Yates with retry to avoid adjacent equal src
      function hasAdjDup(a){
        for (let i=1;i<a.length;i++) {
          const prev = a[i-1].querySelector('img')?.getAttribute('src');
          const cur = a[i].querySelector('img')?.getAttribute('src');
          if (prev === cur) return true;
        }
        return false;
      }
      let attempts = 0;
      do {
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        attempts++;
      } while (hasAdjDup(arr) && attempts < 20);
      // Final pass: if still adj dup, swap offending elements
      for (let i=1;i<arr.length;i++){
        const a = arr[i-1].querySelector('img')?.getAttribute('src');
        const b = arr[i].querySelector('img')?.getAttribute('src');
        if (a === b) {
          const k = (i+1) % arr.length;
          [arr[i], arr[k]] = [arr[k], arr[i]];
        }
      }
      return arr;
    }

    function initInfiniteCarousel(){
      if (initialized || !isMobile()) return;
      initialized = true;

      // Take originals and shuffle to avoid adjacent duplicates
      const originals = Array.from(grid.children);
      const shuffled = shuffleNoAdjDup(originals);
      // Rebuild grid with shuffled originals only once
      grid.innerHTML = '';
      shuffled.forEach(n => grid.appendChild(n));

      const originalCount = shuffled.length;
      if (originalCount === 0) return;

      // Clone one full set on both sides for seamless looping
      const headFrag = document.createDocumentFragment();
      const tailFrag = document.createDocumentFragment();
      shuffled.forEach(node => {
        const c = node.cloneNode(true); c.setAttribute('data-clone', 'true'); headFrag.appendChild(c);
      });
      shuffled.forEach(node => {
        const c = node.cloneNode(true); c.setAttribute('data-clone', 'true'); tailFrag.appendChild(c);
      });
      grid.insertBefore(headFrag, grid.firstChild);
      grid.appendChild(tailFrag);

      let tiles = Array.from(grid.children);
      let index = originalCount; // start at first original after head clones

      function setFocusByIndex(i){
        tiles.forEach((t, idx) => t.classList.toggle('is-focused', idx === i));
      }

      function rotateEggDuringSwipe(icon, direction){
        if (!icon) return;
        // Add class to disable transitions temporarily
        icon.classList.add('swipe-rotating');
        // Set rotation based on swipe direction - rotate OUT of center
        const angle = direction > 0 ? '-12deg' : '12deg';
        icon.style.setProperty('--swipe-rot', angle);
      }

      function centerEgg(icon){
        if (!icon) return;
        // Return to center (0deg) smoothly
        icon.style.setProperty('--swipe-rot', '0deg');
        // Remove class after transition
        setTimeout(()=>{ 
          icon.classList.remove('swipe-rotating');
        }, 300);
      }

      function scrollToIndex(i, behavior){
        tiles[i]?.scrollIntoView({ behavior: behavior || 'smooth', inline: 'center', block: 'nearest' });
        setFocusByIndex(i);
        // Center the newly focused egg
        const newIcon = tiles[i]?.querySelector('.egg-icon');
        centerEgg(newIcon);
      }

      // Jump to the starting position without animation
      scrollToIndex(index, 'auto');

      // Debounced scroll-end detection keeps centering and handles loop jumps
      let scrollTimer = null;
      grid.addEventListener('scroll', () => {
        if (scrollTimer) clearTimeout(scrollTimer);
        scrollTimer = setTimeout(() => {
          const centerX = grid.scrollLeft + grid.clientWidth / 2;
          let closestIdx = index;
          let closestDist = Infinity;
          tiles.forEach((tile, i) => {
            const rect = tile.getBoundingClientRect();
            const gridRect = grid.getBoundingClientRect();
            const tileCenter = rect.left - gridRect.left + rect.width / 2 + grid.scrollLeft;
            const dist = Math.abs(tileCenter - centerX);
            if (dist < closestDist) { closestDist = dist; closestIdx = i; }
          });
          index = closestIdx;

          if (index < originalCount) {
            index += originalCount;
            scrollToIndex(index, 'auto');
          } else if (index >= originalCount * 2) {
            index -= originalCount;
            scrollToIndex(index, 'auto');
          } else {
            setFocusByIndex(index);
          }
        }, 80);
      }, { passive: true });

      // One-step swipe with haptic feedback
      let startX = 0, startY = 0, tracking = false;
      const threshold = 24;
      function haptic(){
        // Try vibration first
        if (navigator.vibrate) {
          navigator.vibrate(10);
        } else if (window.navigator?.vibrate) {
          window.navigator.vibrate(10);
        } else {
          // Fallback: visual feedback for desktop testing
          const currentTile = tiles[index];
          if (currentTile) {
            currentTile.style.transform = 'scale(0.95)';
            setTimeout(() => currentTile.style.transform = '', 100);
          }
        }
      }
      grid.addEventListener('touchstart', (e)=>{
        if (!e.touches || !e.touches[0]) return;
        tracking = true;
        startX = e.touches[0].clientX; startY = e.touches[0].clientY;
      }, { passive: true });
      grid.addEventListener('touchmove', (e)=>{
        if (!tracking || !e.touches || !e.touches[0]) return;
        const dx = e.touches[0].clientX - startX;
        const dy = e.touches[0].clientY - startY;
        if (Math.abs(dx) < threshold && Math.abs(dy) < threshold) return;
        if (Math.abs(dx) > Math.abs(dy)) {
          const dir = dx > 0 ? -1 : 1; // step one card
          // Rotate current egg during swipe
          const currentIcon = tiles[index]?.querySelector('.egg-icon');
          rotateEggDuringSwipe(currentIcon, dir);
          
          index = Math.min(Math.max(index + dir, 0), tiles.length - 1);
          scrollToIndex(index, 'smooth');
          haptic();
          startX = e.touches[0].clientX; startY = e.touches[0].clientY;
        }
      }, { passive: true });
      grid.addEventListener('touchend', ()=>{ tracking = false; });

      // Tap on centered tile to open fortune
      grid.addEventListener('touchend', (e)=>{
        const focused = tiles[index];
        if (!focused) return;
        const touchedTile = e.target.closest('.egg-tile');
        if (touchedTile === focused) focused.click();
      });
    }

    if (isMobile()) initInfiniteCarousel();
    window.addEventListener('resize', () => { if (isMobile()) initInfiniteCarousel(); });
  })();

  // Fortune card hover effect
  (function() {
    const card = document.querySelector('.fortune-card');
    if (!card) return;

    card.addEventListener('mousemove', (e) => {
      const rect = card.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      const centerX = rect.width / 2;
      const centerY = rect.height / 2;

      // Calculate rotation (max 8Â° tilt)
      const rotateX = ((y - centerY) / centerY) * 8;
      const rotateY = ((x - centerX) / centerX) * -8;

      card.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.05)`;
      card.style.setProperty('--x', `${(x / rect.width) * 100}%`);
      card.style.setProperty('--y', `${(y / rect.height) * 100}%`);

      card.classList.add('hovering');
    });

    card.addEventListener('mouseleave', () => {
      card.style.transform = 'rotateX(0deg) rotateY(0deg) scale(1)';
      card.classList.remove('hovering');
    });
  })();
  </script>
</body>
</html>

